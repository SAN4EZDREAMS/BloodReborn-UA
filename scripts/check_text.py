import os
import re
import subprocess
import pandas as pd
from language_tool_python import LanguageTool

# –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –≥—Ä–∞–º–∞—Ç–∏–∫–∏
tool = LanguageTool("uk")

# –ü–∞–ø–∫–∏ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
TARGET_DIRS = ["Lang_check"]
REPORT_FILE = "scripts/spellcheck_report.xlsx"

# –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è —Ç–µ–∫—Å—Ç—É –≤ XML
def extract_text_from_xml(file_path):
    with open(file_path, "r", encoding="utf-8") as f:
        content = f.read()

    matches = re.findall(r'<text id="\d+">([^<]*)</text>', content)
    return [text.strip() for text in matches if text.strip() and not re.match(r"^[\*\%]+$", text.strip())]

# –ü–æ—à—É–∫ —É—Å—ñ—Ö XML-—Ñ–∞–π–ª—ñ–≤ —É –ø–∞–ø–∫–∞—Ö
def find_xml_files():
    xml_files = []
    for target_dir in TARGET_DIRS:
        for root, _, files in os.walk(target_dir):
            for file in files:
                if file.endswith(".xml"):
                    xml_files.append(os.path.join(root, file))
    return xml_files

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ—ñ—ó —á–µ—Ä–µ–∑ aspell
def check_spelling(text):
    process = subprocess.run(
        ["aspell", "-a", "--lang=uk"],
        input=text,
        text=True,
        capture_output=True
    )
    output = process.stdout.split("\n")
    
    errors = []
    for line in output:
        if line.startswith("&"):
            word = line.split()[1]  # –î—Ä—É–≥–∏–π –µ–ª–µ–º–µ–Ω—Ç ‚Äî —Ü–µ —Å–ª–æ–≤–æ –∑ –ø–æ–º–∏–ª–∫–æ—é
            errors.append(word)
    
    return errors

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ñ–∞–π–ª—ñ–≤
def check_files():
    results = []
    
    for file in find_xml_files():
        texts = extract_text_from_xml(file)
        
        for text in texts:
            # –û—Ä—Ñ–æ–≥—Ä–∞—Ñ—ñ—è (—á–µ—Ä–µ–∑ aspell)
            spelling_errors = check_spelling(text)

            # –ì—Ä–∞–º–∞—Ç–∏–∫–∞ (LanguageTool)
            grammar_matches = [
                match for match in tool.check(text)
                if match.ruleId not in ["MORFOLOGIK_RULE_UK_UA"]
            ]

            # –î–æ–¥–∞–≤–∞–Ω–Ω—è –≤ –∑–≤—ñ—Ç
            for word in spelling_errors:
                results.append([file, text, "–û—Ä—Ñ–æ–≥—Ä–∞—Ñ—ñ—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞", word, "‚Äî"])

            for match in grammar_matches:
                results.append([file, text, "–ì—Ä–∞–º–∞—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞", match.ruleId, match.replacements])

    return results

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–≤—ñ—Ç—É
def create_report():
    errors = check_files()
    if not errors:
        print("‚úÖ –ü–æ–º–∏–ª–æ–∫ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!")
        return

    df = pd.DataFrame(errors, columns=["–§–∞–π–ª", "–¢–µ–∫—Å—Ç", "–¢–∏–ø –ø–æ–º–∏–ª–∫–∏", "–ü–æ–º–∏–ª–∫–∞", "–ü—Ä–æ–ø–æ–Ω–æ–≤–∞–Ω–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è"])
    df.to_excel(REPORT_FILE, index=False)
    print(f"üìÑ –ó–≤—ñ—Ç –∑–±–µ—Ä–µ–∂–µ–Ω–æ: {REPORT_FILE}")

if __name__ == "__main__":
    create_report()
